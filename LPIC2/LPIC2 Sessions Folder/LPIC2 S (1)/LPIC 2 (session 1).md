---
tags:
  - LPIC
  - linux
  - command
  - concept
up: "[[LPIC2 Sessions map of content]]"
date: 2023-10-08 1401/07/16
---
> [!idea] یکی از مهمترین مباحثی که در این دوره بهش نیاز داریم دانش شبکه است. 

مروری بر سرفصلهای این فصل
![[Image20231008181844.png]]
### DNS
در پروتوکل TCP/IP چیزی به اسم Name یا Host Name وجود ندارد. و سرویس Domain Name Service یک سرویس اضافی و خارجی است که باید آن را در ساختار شبکمون بگنجونیم.
دلایل استفاده از DNS مختلف است.
1. استفاده از سرویس های عمومی در شبکه بدون host name سخت است. چرا که ip های این سرویس ها احتمالا در مرور زمان بارها تغییر میکنند.
2. ما میتوانیم روی یک سرور با یک ip سرویس ها یا وب سایت های مختلفی رو توسعه بدیم در شرایطی که هر ip می تواند به یک سایت یا سرویس پیش فرض متصل شود. DNS به ما این امکان رو میدهد که روی یک ip سرویس های مختلفی را توسعه بدیم.
3. سرویس DNS حیاتی ترین سرویس یک شبکه است. در صورتی که DNS دچار قطعی شود همه شبکه دچار قطعی و اختلال می شود.
### نحوه عملکرد DNS
زمانی که یک وب سایتی یا سرویسی را فراخوانی میکنیم. در ابتدا نیاز به این داریم که ip مربوط به اون وب سایت یا host name رو پیدا کنیم.
سرویس DNS روی سیستم ما یک سیستم کش کننده یا اصطلاحا Resolver است که اگر آدرس مورد نظر در کش آن ذخیره باشد از آن استفاده میکند و در غیر این صورت آدرس مورد نظر را Lookup می کند.
در سرتاسر دنیا سرورهای DNS وجود دارند که به آنها Root DNS میگوییم اما بین ما و آنها Resolver های مختلفی وجود دارند مثل سرور 8.8.8.8 یا 9.9.9.9 یا 4.2.2.4 که به آنها Cashing DNS server هم میگوییم اما در واقع آنها خودشان ریزالور هایی هستند که به سوالات خود را از روت ها می پرسند.
![[Pasted image 20231012195554.png]]

### ساختار DNS
سیستم DNS یک ساختار درختی دارد که ریشه آن نقطه است.
و به هر لول از آنها یک zone میگوییم.
هر زون سوال پرسیده شده را به زون بعدی واگذار یا delegate میکند و به این صورت به نتیجه نهایی که A query است می رسیم.
> [!idea] باید بدانیم که ریشه تمامی آدرسهای ما نقطه است. این نقطه که در واقعیت بعد از پسوند قرار میگیرد اما در تایپ آدرس نادیده گرفته می شود اما در هنگام تنظیم سرورهای DNS باید آنرا در نظر بگیریم.
 
در عکس زیر فرض میگیرم که میخواهیم دامنه $www.foo.net.$ را lookup کنیم.
1. کامپوننت dns ماشین ما از یک کشینگ DNS این آدرس را لوکاپ میکند.
2. کشینگ DNS مانند 8.8.8.8 از یک سرور روت یا همان نقطه ( $.$ ) سوال میکند.
3. سرور نقطه سوال را به sub domain خودش یعنی $net$ واگذار یا delegate میکند.
4. سرور net که میتواند چندین سرور هم باشد آن را از ساب دومین خودش یعنی $foo.net$ واگذار میکند.
5. سرور $foo.net$ سوال مورد نظر را به ساب دومین های خودش واگذار میکند. و این مسیر میتواند ادامه داشته باشد.
![[domain level.png]]
به لول اول روت، به لول دوم TLD به لول سوم DOMAIN میگوییم
> [!idea] تصمیم گیری در مورد هر زون و ساب دامین های آن به عهده DNS سرور همان زون می باشد.
> یعنی یا پاسخ سوال را می داند یا آن را به ساب دامین های خودش واگذار میکند.

> [!code] [[dig]] #command 
> ابزاری است که فرآیند لوک آپ را برای ما انجام می دهد.
> با استفاده از این ابزار می توانیم ip یک hostname را از یک سرور DNS سوال بپرسیم.
> در جواب یا آدرس سرور های زیرمجموعه را به ما پس می دهد (که به آن پاسخ NS type میگوییم)
> یا ip نهایی را در جواب به ما می دهد (که به آن A type میگوییم)
> ابزار dig ما را نهایتا به جواب A می رساند اما با استفاده از آرگومان +trace میتوانیم فرآیند آن را مشاهده کنیم.

mehdi@mvm:~$ dig A gandotech.com @a.root-servers.net.
;; QUESTION SECTION:
;gandotech.com.                 IN      A
;; AUTHORITY SECTION:
==com.==                    172800  IN      NS      e.gtld-servers.net.
;; ADDITIONAL SECTION:
e.gtld-servers.net.     172800  IN      A       192.12.94.30

mehdi@mvm:~$ dig A gandotech.com @e.gtld-servers.net.
;; QUESTION SECTION:
;gandotech.com.                 IN      A
;; AUTHORITY SECTION:
==gandotech.com.==         172800  IN      NS      igor.ns.cloudflare.com.
==gandotech.com.==          172800  IN      NS      simone.ns.cloudflare.com.
;; ADDITIONAL SECTION:
igor.ns.cloudflare.com. 172800  IN      A       108.162.193.119
simone.ns.cloudflare.com. 172800 IN     A       108.162.194.26

mehdi@mvm:~$ dig A gandotech.com @igor.ns.cloudflare.com.
;; QUESTION SECTION:
;gandotech.com.                 IN      A
;; ANSWER SECTION:
gandotech.com.          300     IN      A       ==78.46.105.196==

در مثال بالا ما به صورت دستی با ابزار dig ابتدا از یک روت سرور آدرس gandotech.com رو بررسی کردیم و مراحل به این صورت بود:
1. روت سرور در بخش آتوریتی جواب خود یک NS رکورد به ما داد و ما را به سرور .com ارجاع داد که ip این سرور در بخش ادیشنال سکشن دیده می شود.
2. سوال را دوباره از سرور .com تکرار کردیم که ما را به سرور gandotech.com ارجا داد.
3. سوال را از سرور gandotech.com تکرار کردیم که مسئول نهایی این آدرس بود و A رکورد را به ما تحویل داد.

> [!idea]  برای یک hostname میتواند بیش از یک ip آدرس وجود داشته باشد که به واسطه load balancing و high availability برای آن تعریف می شود.
> کشینگ سرور ها همیشه آدرس اول در لیست را انتخاب می کنند بنابراین DNS سرورها در هنگام لوکاپ شدن آدرس ip های خود را به صورت رندوم در پاسخ ارسال می کنند.

### مفهوم TTL (time to leave)
در سطر پاسخی که dns سرور ارسال میکند ستونی وجود دارد که در آن عدد TTL را می بینیم.
این عدد نشان دهنده میزان زمانی است که این آدرس می تواند توسط سرورهای دنیا cash شود.
gandotech.com.          300     IN      A       ==78.46.105.196==
مثلا در این نمونه TTL روی 300 ثانیه است.

> [!idea] در سرویس هایی که تازه راه اندازی شدند عدد TTL را یک تا چند دقیقه قرار می دهند. اما در سرویس هایی که پایدار شدند و مدتهاست IP های آن تغییر نکرده TTL را یک تا چند روز قرار میدهند. 
> مزیت TTL بالا این است که رکوئست های کمتری به سمت DNS سرور ما می آید چرا که سرورهای مختلف آدرس های ما را کش کرده اند. و این باعث می شود سرعت پاسخگویی بالاتر باشد.
> از دیگر مزیت های آن این است که اگر DNS سرور ما از کار بیفتد سایت تا حد زیادی از دسترس خارج نمی شود. چرا که آدرس های ما توسط DNS سرورهای مختلف دنیا کش شده اند.

#### Negative TTL
اگر یک کشینگ سرور آدرسی را جستجو کند و ip مورد نظر را پیدا نکند، در دسترس نبودن آن را به این اندازه کش می کند.

> [!idea] به صورت پیش فرض DNS ها روی پورت 53 و پروتکول UDP در شبکه کار میکند.

> [!idea] سرویس DNS هم در سازمان یا نرم افزاری که سرویس های مختلفی دارد کاربرد دارد و هم در فضای اینترنت.
> تفاوت آنها در این است که آدرس های Domain در فضای اینترنت و همینطور ip سرورها خریدنی هستند، اما در شبکه لوکال در صورتی که آدرس ها به خارج از شبکه delegate نمی شوند می توانیم از هر ip و hostname که میخواهیم استفاده کنیم. 

> [!question] آیا ما دسترسی تغییر ip روی هاستی که برای وبسایتمون خریداری کردیم مثل کلودفلر را داریم؟
> خیر تنظیم ip های مربوط به سرویس های dns خارج از هاست خودمان به عهده ما نیست.

> [!question] ما یک دامنه داریم و از کلودفلر سرویس DNS میگیرم. مثلا میگیم برای foo.gandotech.com برو به آدرس 185.1.2.3. چرا باید روی سرور خودمون دوباره ns1 تعریف کنیم و A رکورد بدیم به 185.1.2.3
> کلودفلر تمامی رکوئست های مربوط به زون foo.gandotech.com رو به dns ما به ادرس 185.1.2.3 ارسال میکند. این آدرس ها میتواند مربوط به خود دومین یا سابدومین ها باشد. بنابراین ما تعریف میکنیم که رکوئست مربوط به وب را روی ip سرویس دهی کنیم و مثلا رکوئست ایمیل را روی دامنه ای دیگر بهمراه ip دیگر

### تایپ های مختلف در پاسخ کوئری های DNS
مهمترین رکوردهای پاسخ A و NS هستند.
A: پاسخ نهایی که حاوی حداقل یک ip در ازای hostname است.
NS: سروری که برای یافتن پاسخ به آن سرور ارجاع داده شده ایم و باید سوال را مجددا از آن سرور بپرسیم
MX: برای هر زون میتواند تعریف شود و آدرس ایمیل سرور آن زون است. برای اینکه بتوانیم به ایمیل یک سرور دسترسی پیدا کنیم باید MX رکورد آن را لوکاپ کنیم.
SOA: به معنای Start of Authority یک رکورد بسیار مهم است که اطلاعات خاصی را درخورد دارد. 
-  negative ttl در این رکورد ذخیره می شود. 
- ایمیل ادمین این سرور در این رکورد ذخیره می شود.
- اعداد serial , refresh , retry , expire در این رکورد ذخیره می شود.
CNAME: یا همان canonical name زمانی استفاده می شود، که میخواهیم A رکورد یک ساب دامین را از یک ساب دامین دیگر فراخوانی کنیم.
**حداقل کانفیگ یک DNS شامل SOA رکورد و یک NS می باشد. و درصورتی که NS ما یکی از ساب دومین های خودمان باشد باید یک A رکورد هم برای آن در نظر بگیریم که همان Glue رکورد است.**
```shell
mehdi@mvm:~$ dig mx gandotech.com
;; ANSWER SECTION:
gandotech.com.          5       IN      MX      10 mx.zoho.eu.
gandotech.com.          5       IN      MX      20 mx2.zoho.eu.
gandotech.com.          5       IN      MX      50 mx3.zoho.eu.
```
عددی که در کوئری mx قبل از آدرس قرار دارد (درمثال بالا 10 و 20 و 50) اولویت استفاده از سرورهای ایمیل است.
> [!idea] دستور net cat یا nc بسیار در شبکه کاربرد دارد. 
### Bind
نرم افزاری است که برای ایجاد یک DNS سرور از آن استفاده می کنیم.
با دستور زیر آنرا نصب میکنیم
sudo apt install bind9
دستورات و کانفیگ سرور بایند روی توزیع های مختلف در فایلهای مختلفی قرار دارند، در ابونتو از فایل زیر جهت کانفیگ بایند استفاده میکنیم.
etc/bind/[[named.conf]]
این فایل، کانفیگوریشن اصلی ماست اما میتوانیم با دستور include از فایل های دیگر هم کانفیگوریشن ایمپورت کنیم.
```shell
root@mvm:/etc/bind# vim named.conf
// This is the primary configuration file for the BIND DNS server named.
//
// Please read /usr/share/doc/bind9/README.Debian.gz for information on the
// structure of BIND configuration files in Debian, *BEFORE* you customize
// this configuration file.
//
// If you are just adding zones, please do that in /etc/bind/named.conf.local

include "/etc/bind/named.conf.options";
include "/etc/bind/named.conf.local";
include "/etc/bind/named.conf.default-zones";
```
بایند به صورت پیش فرض تنظیمات خودش رو به سه بخش مختلف تقسیم بندی کرده و ازین سه فایل include میکند. اما ما میتوانیم اینها را پاک کنیم و تمامی تنظیمات را در همین فایل انجام دهیم.
1.  named.conf.options; این فایل مربوط به آپشن هاییست که برای بایند میخواهیم در نظر بگیریم.
2.  named.conf.local"; این فایل خالیه و زون هایی که این بایند در این ماشین میخواهد انجام دهد را باید اینجا تنظیم کنیم.
3.  named.conf.default-zones"; دیفالت زون ها دراین فایل قرار میگیرند مثل کشینگ سرور های دنیا و با هر اپدیت بروزرسانی می شوند.
در بایند توضیحات با // نوشته می شوند.
در بایند پایان هر خط یا دستوری باید ; قرار دهیم.
نمونه ای از کانفیگ بایند [[named.conf]]
> [!danger] Glue Record
> اگر value سرور DNS ما ساب دامینی از سایت خودمان باشد. بنابراین برای آن ساب دامین باید یک A رکورد به همراه ip تعریف کنیم که اصطلاحا به آن glue رکورد گفته می شود. اما اگر value سرور DNS ما یک دامنه از یک شرکت سرویس دهنده خارجی باشد مثل پارس پک یا ایران هاست، صرفا آدرس DNS آن سرویس دهنده را به عنوان value قرار می دهیم، و به ip آن توجه نمی کنیم.

> [!idea]  پیشنهاد می شود در سازمان ها از ip های invalid اینترنتی استفاده شود. چرا که در صورت استفاده از ip های رنج valid از درون سازمان دسترسی به سایتهایی که ip های مشابه با ip های استفاده در سازمان دارند قطع خواهد شد.