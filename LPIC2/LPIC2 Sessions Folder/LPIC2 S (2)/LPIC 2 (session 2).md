---
tags:
  - LPIC
  - linux
  - command
  - concept
up: "[[LPIC2 Sessions map of content]]"
date: 2023-10-14
---
#### تنظیم ایمیل سرور روی bind
برای تنظیم این رکورد به فایل [[named.conf]] می رویم

> [!danger] در تعریف رکورد های مختلف در کانفیگ DNS سرور، فقط A رکورد است که مقدار ip دریافت میکند و بقیه رکورد ها باید مقدار hostname داشته باشند.

در هنگام کانفیگ DNS ابتدا باید به این سوال پاسخ بدیم که ما برای چه ساب دامینی از زون خودمان میخواهیم یک رکورد تعریف کنیم؟ 
1. و پاسخ تعیین کننده ستون اول است:
برای تعریف اوریجین : از @ استفاده میکنیم مثلا foo.gandotech.com
با تعریف shiraz : به این آدرس میرسیم: shiraz.foo.gandotech.com
با تعریف www: به این آدرس می رسیم: www.foo.gandotech.com
2. در ستون دوم تایپ رکورد را تعیین میکنیم
برای تعریف Name Server برای کل زون : @  NS
برای تعریف Name Server شعبه اهواز : ahwaz  NS
برای ایجاد یک سایت روی اوریجین باید به آن ip بدهیم. اما این موضوع اجباری نیست : @   A 
برای تعریف mail Server برای زون اصلی @  MX 
میل سرور یک ستون priority اضافه دارد 
3. در ستون سوم مقدار یا Value را وارد میکنیم.
مقدار تمامی تایپ ها از نوع host name است به جز A رکورد که ip است.
تعریف TTL برای تمامی موارد اختیاری است. چرا که در ابتدای کانفیگ یک TTL پیش فرض تعیین کردیم.
> [!idea] تنها مواردی که در کانفیگ اولیه DNS اجباریست یک SOA  و یک NS است. و اگر NS یک ساب دامین از خود زون است باید یک A رکورد برای NS در نظر گرفت

#### رکورد TXT
یک رکورد کمکی است که میتوانیم برای هر چیزی از آن استفاده کنیم.
مثلا برای ایجاد یک کامنت یا متن یا پابلیک برای زون اوریجین یا ساب دامین ها تعریف کنیم.
برخی از وب سایت ها برای اعتبار سنجی تقاضای تعریف یک TXT رکورد از ما میکنند.
```SHELL
@ TXT "salam"
```

#### cashing DNS
دو دسته DNS سرور داریم
1.  DNS سرورهایی که جواب نهایی را دارند و میتوان از آنها authoritative answer دریافت کرد.
2.  cashing DNS سرورهایی که سوال را delegate میکنند و از آنها Non-authoritative answer دریافت میکنیم. به این سرورها resolver هم میگوییم.
ریزالورها در جایی تعریف می شوند که ترافیک DNS زیاد است.
در bind به ریزالور ها سرور recursive گفته می شود.

**با کانفیگ یک سرور با استفاده از bind ما خود به خود یک کشینگ سرور داریم.
این یعنی از داخل شبکه اگر کسی برای یک hostname خارج از شبکه رکوئست بزند پاسخ دریافت میکند.
اما نباید این کانفیگ جوری باشد که کسی از خارج از شبکه برای یک hostname خارج از شبکه رکوئست بزند. چرا که امنیت سیستم پایین می آید.
مگر اینکه ما قصد ایجاد یک سرویس عمومی DNS داشته باشیم.**

> [!idea] باید در نظر داشته باشیم که کار DNS لوکاپ کردن برای پیدا کردن ipهای متناظر با هاستی است که جستجو شده. اگر هاست جستجو شده در خود سرور تعریف شده باشد که پاسخ را میداند و در صورتی که تعریف نشده باشد با استفاده از بستر اینترنت این سوال را از DNS های دیگر می پرسد. این قابلیت در صورتی که آپشن کشینگ یا همان ریکرسیو خاموش باشد، غیرفعال است. 
> ریکرژن به صورت پیش فرض برای شبکه داخلی خودش فعال است.
#### تنظیمات بایند
برای تنظیمات بایند به فایل etc/bind/[[named.conf]].options مراجعه میکنیم.
در این فایل دایرکتیو های مختلفی برای تنظیمات داریم.
دایرکتیو listen: تنظیم باز بودن کارت شبکه ها برای رکوئست های ورودی DNS که پیش فرض آن any است.
دایرکتیو allow-query: تنظیم ip هایی که میتوانند به سرور ما رکوئست بزنند. که پیش فرض آن any است.
دایرکتیو recursion no: کشینگ سرور در این سرور غیر فعال است.
دایرکتیو recursion yes: کشینگ سرور در این سرور فعال است. پیش فرض هم yes است.
دایرکتیو allow-recursion: آی پی هایی که میتوانند ازین سرور به عنوان کشینگ سرور استفاده کنند در اینجا تعریف می شوند.
دایرکتیو blackhole: برای مسدود کردن ip یا ip هایی که نمی خواهیم به سرور ما رکوئست بزند. 
> [!idea]  ipهایی که در allow-query نباشند پاسخ refused میگیرند اما ipهایی که در blackhole باشند تایم اوت می شوند

> [!idea] allow-query تمامی رکوئست های recursive , non-recursive رو پاسخ می دهد اما برای محدود کردن رکوئست های رکرژن از allow-recursion استفاده می کنیم.

![[named.conf#named.conf.options]]

##### نمونه ای از تنظیمات DNS یک سازمان
ریکرژن روشن (که آبدیت های نرم افزاری انجام شود)
الوریکرژن برای ip های داخل سازمان تعریف شود (که dns سازمان سرویس عمومی ندهد) اما از داخل سازمان بتوان به اینترنت وصل شد.
لیسن آن برای ip های خارج و داخل سازمان که هم زون های تعریف شده روی سرور قابل جستجو از بیرون باشد و هم رکوئست های داخلی پاسخ داده شود.

##### نمونه ای از تنظیمات DNS شرکتهای سرویس دهنده به وب سایت ها
ریکرژن برای همه خاموش (چون فقط باید رکوئست مربوط به زون خودش را پاسخگو باشد.)
لیستن برای همه باز
الوکوئری برای همه باز
> [!question] زمانی که ما میتوانیم از دایرکتیو allow-query استفاده کنیم دایرکتیو لسن به چه کاری می اید.؟

##### نمونه ای از تداخل recursion vs delegation
![[Pasted image 20231014210423.png]]
در این سناریو چون ریکرژن برای خارج از سازمان بسته است در صورت لوکاپ شدن ساب دومین shiraz توسط مثلا 8.8.8.8 ، سرور DNS ما صرفا delegate می کند و وظیفه ای برای لوکاپ کردن ندارد.
اما اگر از داخل سازمان ساب دامنه shiraz لوکاپ شود سرور DNS ما وظیفه دارد این ساب دامنه را لوکاپ کند و به کلاینت خود پاسخ دهد، بنابراین ریکرژن برای داخل سازمان باید روشن باشد.

> [!question] delegation و recursion چه تفاوتی دارند؟
> وقتی از یک DNS سرور در هر لایه ای سوالی پرسیده می شود، آن سرور پاسخ را به ساب دومین های خود واگذار یا دلیگیت میکند، و این روند به قدری ادامه می یابد که به سروری برسیم که آدرس ip مربوط به hostname پرسیده شده در اون باشد. 
> اما فرایند باز پرسیدن توسط DNS مبدا را recursion می نامیم که اگر روشن باشد، بار DNS زیادی به سرور تحمیل می شود.


> [!question] مفهوم Recursion چیست؟
> یعنی سروری که لوکاپ میکند و پاسخ ها را کش می کند

#### forward
برای شرایطی است که نمی خواهیم کار لوکاپ توسط DNS ما انجام شود.
یعنی کوئری رو دریافت میکنیم اما اون رو به سروری دیگه انتقال میدیم
```shell
;forwarders { 8.8.8.8; }
```


> [!idea] وب سایتی برای یادگیری و کانفیگ های #DNS 
> www.zytrax.com 

#### forward zone
برای شرایطی است که نمیخواهیم تمام DNS را فورارد کنیم بلکه میخواهیم یک یا یک سری دومین خاص را فوروارد کنیم.
```shell
zone 'subzone.mydns.example.com' {
	type forward:
	forwarders { 192.168.0.1; };
};

zone 'ubuntu.com' {
	type forward:
	forwarders { 4.2.2.4; };
};
```

> [!code] [[tcpdump]]  #command
> برای بررسی ترافیک شبکه که میتوانیم پکت ها رو بررسی کنیم.

![[Pasted image 20231015125006.png]]

#### نحوه کار DNS در ubuntu
ریزالوری که در systemd داریم کارش صرفا فورارد کردن رکوئست هاست
```shell
root@mvm:~# cat /etc/resolv.conf
# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
# Do not edit.
nameserver 127.0.0.53
options edns0 trust-ad
search localdomain
root@mvm:~# nslookup google.com
Server:         127.0.0.53
Address:        127.0.0.53#53

Non-authoritative answer:
Name:   google.com
Address: 216.239.38.120
```
میبینیم که رکوئست های ما از سرویسی روی لوپ بک پرسیده می شود که در فایل resolve.conf قرار دارد. و لوپ بک صرفا یک فورواردری است که رکوئست ها را به DNS سروری که در شبکه تعریف شده فوروارد می کند.
![[Pasted image 20231015125911.png]]

#### resolvectl
این دستور تعیین میکند که ریزالور لوپ بک رکوئست ها را به چه آدرسی فوروارد میکند که در مثال پایین می بینیم.
خود resolvectl کار کشینگ رو هم انجام میده و به نوعی یک dns داخلی در لینوکس است.
```shell
root@mvm:~# resolvectl status
Global
       Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
resolv.conf mode: stub

Link 2 (ens33)
    Current Scopes: DNS
         Protocols: +DefaultRoute +LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
Current DNS Server: 192.168.243.2
       DNS Servers: 192.168.243.2
        DNS Domain: localdomain
```


> [!idea] چرا اغلب از دو DNS سرور استفاده می کنیم؟
> چرا که اگر DNS سرور ما از کار بیفتد ip سرویس ما قابل لوکاپ شدن نخواهد بود و عملا سرویس ما از دسترس خارج می شود.

#### نکات مهم در ایجاد دو DNS سرور
هر دو DNS باید مثل هم کانفیگ شده باشند
باید ip های متفاوتی داشته باشند
باید دو لینک اینترنت متفاوت داشته باشند
بهتر است که هاست اونها از لحاظ مکانی از هم جدا باشند (یعنی اگر شعبه داریم یکی از آنها در شعبه دوم باشد)
اگر از لحاظ مکانی در یک جا هستند بهتر است که سرور و esx اونها از هم جدا باشند.

> [!idea] چطور میتوانیم کانفیگوریشن دو DNS را باهم sync نگه داریم؟
> مکانیزم های مختلفی وجود دارد مثل rsync و یا کپی کردن دستی اما میتوانیم از معماری های master slave هم استفاده کنیم. 

#### master slave
- چیدن این معماری در DNS سرورها باعث میشود slave از master تبعیت کند و هر تغییر در master در slave هم اعمال می شود.
- چیدمان master slave اصطلاحا per zone اتفاق می افتد و نمیتوان کل سرور را master یا slave کرد. اما میتوان این کار را با تمام zone ها یا برخی از zone های سرور انجام داد.
- معمولا اینگونه کانفیگ میکنیم که همه zone های یک سرور را master و همه zone های یک سرور را slave قرار می دهیم.
- یک master میتواند چندین slave داشته باشد و یک slave هم میتواند چندین master داشته باشد.
- حالت مختلفی از معماری master slave
1. حالت اول هر دو مستر هستند
2. حالت دوم یک سرور مستر و دیگری اسلیو است
3. حالت سوم یک مستر داریم که روی اینترنت فعال یا اصطلاحا اکسپوز نیست. و اسلیو ها که به سرویس دهنده هستند از مستر بروزرسانی می شوند
![[Pasted image 20231015142521.png]]

#### Zone Transfer
 بروزرسانی در زون های master , slave را زون ترنسفر میگوییم.
 ![[Pasted image 20231015143927.png]]
 برای zone transfer باید زون مستر را کانفیگ کنیم و در آن اطلاعات dns را قرار دهیم اما زون اسلیو را کانفیگ میکنیم اما در فایل آن هیچ اطلاعاتی قرار نمی دهیم.
 مواردی که در SOA رکورد زون مستر است تعیین کننده عملکرد zone transfer می باشد.
 -  serial اگر سریال مستر از اسلیو عدد بزرگتری باشد zt اتفاق می افتد
	 - بنابراین با هر تغییر در DNS سریال را افزایش میدهیم . مثلا میتوانیم از اعداد تاریخ روز استفاده کنیم.
 -  Refresh یک عدد به ثانیه است که تعیین کننده دوره زمانی است که اسلیوها باید zt را انجام دهند.
 -  Retry یک عدد به ثانیه است که اگر zt مثلا به دلیل قطع اینترنت یا هر مشکل دیگه ای درست انجام نشود، ازین زمان برای مراجعه مجدد استفاده میکند.
 -  Expire مدت زمانی است که زون های اسلیو منقضی می شود و باید قطعا دوباره از مستر بروزرسانی شود.
 *اعداد زمان ها در bind به ثانیه هستند اما از M H D W به معنای دقیقه ساعت روز هفته استفاده کنیم.*
 
 نمونه ای از کانفیگ SOA رکورد
```shell
@ IN SOA ns.foo.gandotech.com. akbar.gmail.com (
        2023101201; Serial
        1H; Refresh
        60; Retry
        1D; Expire
        300; Negative TTL
)
```

> [!idea] چرا باید رابطه بین master, slave امن باشد؟
> چرا که اگر امن نباشد امکان هک شدن وجود دارد و اتکر میتواند یک سرور دیگری را به جای master جایگزین کند و A رکورد های مارا تغییر دهد 
#### PTR رکورد
- این رکورد تایپ به معنای reverse DNS است. یعنی بدین صورت که با لوکاپ کردن یک ip بتوانیم hostname متناظر با اون رو پیدا کنیم.
- با توجه به اینکه بین بخش های مختلف ip نقطه وجود دارد میتوانیم هر کدام را ساب دامین بخش بعدی در نظر بگیریم (مکانیزم ARPA) و لوکاپ رو انجام بدیم و در مقابل رکوردی برای ip مذکور تعریف کنیم که مقدار اون مثل MX و NS یک hostname است.
- این رکورد را در زون معمولی نمیشود تعریف کرد و باید در یک زون مجزا تعریف شود.
- برای لوکاپ کردن یک PTR باید از dig -x استفاده کنیم و یک ip رو لوکاپ کنیم.
وقتی از یک شرکت فروشنده هاست DNS میگیرم میتوانیم تقاضا کنیم که در مقابل ip های ولیدی که به ما فروخته PTR ما را قرار دهد. این امر در سرویس هایی مثل ایمیل خیلی مهم است.
سرویس دهنده های ایمیل مثل gmail یا yahoo این موضوع را چک میکنند با استفاده از reverse lookup کردن سورس ip فرستنده ایمیل و مقایسه اون با mx رکورد یک ایمیل متوجه می شوند که فرستنده ایمیل صاحب domain و ip است و سرور درستی این ایمیل را ارسال کرده و سرور دیگری خودش را جایگزین نکرده است. در غیر این صورت ایمیل های فرستنده spam می شود.
![[Pasted image 20231015152450.png]]